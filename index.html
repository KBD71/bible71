<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https:; frame-src 'self' https://www.youtube.com https://youtube.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.youtube.com https://cdn.tailwindcss.com https://fonts.googleapis.com;">
    <title>말씀의 샘</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23764ba2'><path d='M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253'/></svg>">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com?v=3.4.0&cache-bust=20250915"></script>
    <script>
        tailwind.config = {
            content: ["./index.html"],
            theme: {
                extend: {}
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --color-primary: #8B0000;
            /* 짙은 붉은색 */
            --color-secondary: #004D40;
            /* 짙은 청록색 */
            --color-accent: #DAA520;
            /* 금색 포인트 */
            --color-text-main: #4E342E;
            /* 어두운 갈색 (메인 텍스트) */
            --color-text-light: #6D4C41;
            /* 밝은 갈색 (보조 텍스트) */
            --color-parchment: #F5EFE6;
            /* 양피지색 */
            --color-card-bg: rgba(78, 52, 46, 0.25);
            /* 카드 배경 (투명 갈색) */
            --color-card-border: rgba(218, 165, 32, 0.2);
            /* 카드 테두리 (투명 금색) */
        }

        html {
            height: 100%;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            min-height: 100dvh;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: -1;
            background-image: url('back2.png');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-color: #2c1e1a;
        }

        /* Mobile Landscape Optimization */
        @media (max-width: 767px) and (orientation: landscape) {
            body::before {
                background-position: center 40%;
            }
        }

        /* Desktop/Laptop Optimization */
        @media (min-width: 768px) {
            body::before {
                background-position: center center;
            }
        }

        .serif {
            font-family: 'Noto Serif KR', serif;
        }

        .main-container-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 100dvh;
            padding: 1rem;
        }

        @media (min-width: 768px) {
            .main-container-wrapper {
                justify-content: flex-start;
                padding: 2rem;
            }
        }

        .modern-card {
            background: var(--color-card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--color-card-border);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 420px;
            width: 100%;
        }

        .header-title {
            color: var(--color-parchment);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .header-subtitle {
            color: var(--color-parchment);
            opacity: 0.8;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
        }

        .header-icon-bg {
            background: rgba(245, 239, 230, 0.15);
            border: 1px solid rgba(245, 239, 230, 0.25);
        }

        .date-display {
            background: rgba(245, 239, 230, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid var(--color-card-border);
            color: var(--color-parchment);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
        }

        .date-display:hover {
            background: rgba(245, 239, 230, 0.2);
            transform: scale(1.03);
        }

        .icon-button {
            background: rgba(245, 239, 230, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid var(--color-card-border);
            color: var(--color-parchment);
            transition: all 0.3s ease;
        }

        .icon-button:hover {
            background: rgba(245, 239, 230, 0.2);
            transform: scale(1.05);
        }

        .category-group {
            background-color: var(--color-text-main);
            padding: 0.8rem;
            border-radius: 1rem;
        }

        .category-button {
            border: 1px solid rgba(245, 239, 230, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            padding: 0.8rem;
            font-size: 0.95rem;
            border-radius: 1rem;
            color: var(--color-parchment);
            font-weight: 500;
        }

        .category-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .category-button.primary {
            background-color: var(--color-primary);
        }

        .category-button.secondary {
            background-color: var(--color-secondary);
        }

        .category-button.accent {
            background-color: var(--color-accent);
            color: #371F1B;
        }

        .calendar-modal {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }

        .calendar-container {
            background: var(--color-parchment);
            border: 1px solid var(--color-accent);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            color: var(--color-text-main);
        }

        .calendar-header {
            border-bottom: 1px solid var(--color-card-border);
        }

        .calendar-day-header {
            color: var(--color-text-light);
        }

        .saturday-header-color {
            color: #2563eb;
        }

        .sunday-header-color {
            color: #dc2626;
        }

        .calendar-day {
            background: #fff;
        }

        .calendar-day:hover {
            background: #fdfaf5;
        }

        .calendar-day.other-month {
            color: #ccc;
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: var(--color-accent);
            color: white;
            font-weight: bold;
        }

        .calendar-day.selected {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
            background-color: rgba(139, 0, 0, 0.1);
        }

        .saturday-day-color {
            color: #2563eb;
        }

        .sunday-day-color {
            color: #dc2626;
        }

        #close-calendar {
            background-color: var(--color-text-light);
        }

        #close-calendar:hover {
            background-color: var(--color-text-main);
        }

        .content-view {
            background: var(--color-parchment);
        }

        .content-header {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
        }

        .home-button {
            background: var(--color-text-main);
            color: white;
        }

        .home-button:hover {
            background: var(--color-primary);
        }

        #content-title {
            color: var(--color-text-main);
        }

        .loading-spinner {
            border-top-color: var(--color-primary);
        }

        .custom-button {
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            padding: 0.8rem 1.2rem;
            font-size: 0.95rem;
            border-radius: 1rem;
            color: var(--color-parchment);
            border: 1px solid rgba(245, 239, 230, 0.3);
        }

        .custom-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .custom-button:active {
            transform: scale(0.98);
        }

        /* Loading State for Buttons */
        .button-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .button-loading::after {
            content: "";
            position: absolute;
            width: 1.2em;
            height: 1.2em;
            top: 50%;
            left: 50%;
            margin-top: -0.6em;
            margin-left: -0.6em;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #player-play-pause:active {
            transform: scale(0.90);
            transition: transform 0.1s;
        }

        .custom-button.sermon {
            background-color: #5D4037;
            /* Deep Warm Brown to match the theme */
        }
    </style>
</head>

<body class="bg-gray-900">

    <div class="main-container-wrapper">
        <div class="modern-card rounded-3xl z-10 overflow-hidden">
            <header class="text-center p-6 sm:p-8">
                <div class="mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 header-icon-bg rounded-2xl flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                            </path>
                        </svg>
                    </div>

                    <h1 class="text-2xl sm:text-3xl font-bold header-title serif">말씀의 샘</h1>
                    <p class="text-sm header-subtitle font-light tracking-widest">Fountain of the Word</p>
                </div>

                <div class="flex items-center justify-center space-x-2 sm:space-x-4">
                    <button id="prev-day" class="icon-button p-3 rounded-full">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                            </path>
                        </svg>
                    </button>

                    <div class="rounded-xl px-4 py-2 date-display cursor-pointer" id="date-picker">
                        <p id="current-date"
                            class="text-base sm:text-lg font-semibold text-center min-w-[140px] sm:min-w-[180px]"></p>
                    </div>

                    <button id="next-day" class="icon-button p-3 rounded-full">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </button>
                </div>
            </header>

            <main class="px-6 pb-6 sm:px-8 sm:pb-8 space-y-3">
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <button class="custom-button sermon sermon-button w-full font-bold text-base sm:text-lg py-3"
                        data-prefix="ae">장년교육</button>
                    <button class="custom-button sermon sermon-button w-full font-bold text-base sm:text-lg py-3"
                        data-prefix="ms">오전강설</button>
                    <button class="custom-button sermon sermon-button w-full font-bold text-base sm:text-lg py-3"
                        data-prefix="as">오후강설</button>
                </div>
                <div class="category-group w-full">
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-[var(--color-parchment)]" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-semibold text-[var(--color-parchment)]">매일의 말씀</span>
                    </div>
                    <div class="grid grid-cols-1 gap-2 mt-3">
                        <div class="link-container" data-prefix="db">
                            <button class="category-button secondary w-full">
                                <div class="flex items-center justify-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                                        </path>
                                    </svg>
                                    <span>매일성경 (새벽기도)</span>
                                </div>
                            </button>
                        </div>
                        <div class="link-container" data-prefix="mc">
                            <button class="category-button primary w-full">
                                <div class="flex items-center justify-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    <span>맥체인 성경읽기</span>
                                </div>
                            </button>
                        </div>
                        <div class="link-container" data-prefix="day">
                            <button class="category-button accent w-full">
                                <div class="flex items-center justify-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                        </path>
                                    </svg>
                                    <span>날.양.웨.표준교리</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="calendar-modal" class="calendar-modal fixed inset-0 z-50 items-center justify-center"
        style="display: none;">
        <div class="calendar-container rounded-2xl w-full max-w-sm mx-4">
            <div class="calendar-header flex items-center justify-between p-4">
                <button id="prev-month" class="p-2 rounded-full hover:bg-black/10 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                </button>
                <h3 id="calendar-title" class="text-lg font-semibold serif"></h3>
                <button id="next-month" class="p-2 rounded-full hover:bg-black/10 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
            <div class="calendar-grid p-2 grid grid-cols-7 gap-1" id="calendar-grid"></div>
            <div class="p-3 border-t border-black/10">
                <button id="close-calendar" class="w-full text-white py-2 px-4 rounded-lg transition-colors">닫기</button>
            </div>
        </div>
    </div>

    <div id="content-view" class="content-view fixed inset-0 z-[100] flex flex-col" style="display: none;">
        <div class="content-header shadow-md p-4 flex items-center justify-between bg-white z-10">
            <button id="home-button"
                class="home-button py-2 px-4 rounded-lg font-semibold flex items-center transition-colors shrink-0">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
                <span class="hidden sm:inline">홈으로</span>
            </button>

            <div class="flex items-center space-x-2 mx-4">
                <button id="font-decrease" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors"
                    title="글자 작게">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg>
                </button>
                <span class="text-sm font-medium text-gray-500 select-none">글자 크기</span>
                <button id="font-increase" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors"
                    title="글자 크게">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="w-8"></div> <!-- Spacer for balance -->
            <h2 id="content-title"
                class="text-xl sm:text-2xl lg:text-3xl font-bold serif mx-4 text-center flex-1 truncate hidden"></h2>
        </div>
        <div class="content-body flex-1 relative">
            <div id="loading-spinner"
                class="loading-spinner absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 border-4 border-gray-200 border-t-4 rounded-full animate-spin">
            </div>
            <iframe id="content-iframe" class="w-full h-full border-none" style="display: none;" allowfullscreen
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
            <div id="error-message"
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white/95 backdrop-blur-md border rounded-lg p-6 text-center shadow-lg"
                style="display: none;">
            </div>
        </div>
    </div>

    <script>
    </script>
    <!-- Global Audio Player -->
    <div id="global-player"
        class="fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur-md border-t border-gray-700 p-4 z-[200] transform transition-transform duration-300 translate-y-full"
        style="display: none;">
        <div class="max-w-3xl mx-auto">
            <div class="flex flex-col space-y-2">
                <!-- Title and Controls Row -->
                <div class="flex items-center justify-between text-white">
                    <div class="flex items-center space-x-3 overflow-hidden">
                        <button id="player-expand" class="p-2 hover:bg-gray-800 rounded-full transition-colors"
                            title="본문 보기">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h7"></path>
                            </svg>
                        </button>
                        <span id="player-title" class="text-sm font-medium truncate">재생 중인 콘텐츠</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Speed Control -->
                        <select id="player-speed"
                            class="bg-gray-800 text-xs rounded px-2 py-1 border border-gray-700 focus:outline-none focus:border-gray-500">
                            <option value="0.75">0.75x</option>
                            <option value="1.0" selected>1.0x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2.0">2.0x</option>
                        </select>
                        <!-- Play/Pause -->
                        <button id="player-play-pause"
                            class="p-2 bg-white text-gray-900 rounded-full hover:bg-gray-200 transition-colors">
                            <svg id="icon-play" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <svg id="icon-pause" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <!-- Close -->
                        <button id="player-close"
                            class="p-2 hover:bg-gray-800 rounded-full transition-colors text-gray-400 hover:text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Progress Bar Row -->
                <div class="flex items-center space-x-3">
                    <span id="current-time" class="text-xs text-gray-400 w-10 text-right">0:00</span>
                    <input type="range" id="player-progress" min="0" max="100" value="0"
                        class="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-white">
                    <span id="duration" class="text-xs text-gray-400 w-10">0:00</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let calendarDate = new Date();
        let currentFontSize = 100; // Percentage
        let ytPlayer = null;
        let playerInterval = null;
        let isDragging = false;

        function pad(num) {
            return num < 10 ? '0' + num : String(num);
        }

        function formatTime(seconds) {
            if (!seconds) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${pad(s)}`;
        }

        function updatePageForDate(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const daysOfWeek = ["일", "월", "화", "수", "목", "금", "토"];
            const dayOfWeek = daysOfWeek[date.getDay()];

            const dateDisplay = document.getElementById('current-date');

            if (window.innerWidth < 640) {
                dateDisplay.textContent = `${month}/${day} (${dayOfWeek})`;
            } else {
                dateDisplay.textContent = `${year}년 ${month}월 ${day}일 (${dayOfWeek})`;
            }

            // 매일의 말씀, 맥체인, 교리 버튼 링크 업데이트
            document.querySelectorAll('.link-container').forEach(container => {
                const prefix = container.dataset.prefix;
                const button = container.querySelector('button');
                let url = '';

                if (prefix === 'mc') {
                    const dateSuffix = `${pad(month)}${pad(day)}`;
                    url = `./mccheyne/mc${dateSuffix}.html`;
                } else if (prefix === 'db') {
                    const yearSuffix = String(year).slice(-2);
                    const dateSuffix = `${yearSuffix}${pad(month)}${pad(day)}`;
                    url = `./dailybible/db${dateSuffix}.html`;
                } else if (prefix === 'day') {
                    const dateSuffix = `${pad(month)}${pad(day)}`;
                    url = `./catechism/dc${dateSuffix}.html`;
                }

                if (button && url) {
                    button.dataset.url = url;
                    console.log(`Updated ${prefix} button url: ${url}`);
                }
            });

            // 주일 설교 버튼 링크 업데이트
            const lastSunday = new Date(date);
            lastSunday.setDate(date.getDate() - date.getDay());
            const yearSuffix = String(lastSunday.getFullYear()).slice(-2);
            const sermonDateSuffix = `${yearSuffix}${pad(lastSunday.getMonth() + 1)}${pad(lastSunday.getDate())}`;

            document.querySelectorAll('.sermon-button').forEach(button => {
                const prefix = button.dataset.prefix;
                if (prefix) {
                    const url = `./sermon/${prefix}${sermonDateSuffix}.html`;
                    button.dataset.url = url;
                    console.log(`Updated sermon ${prefix} button url: ${url}`);
                }
            });
        }

        function generateCalendar(year, month) {
            const calendarGrid = document.getElementById('calendar-grid');
            const calendarTitle = document.getElementById('calendar-title');
            if (!calendarGrid || !calendarTitle) return;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const today = new Date();
            calendarTitle.textContent = `${year}년 ${month + 1}월`;
            calendarGrid.innerHTML = '';
            const dayHeaders = ['일', '월', '화', '수', '목', '금', '토'];
            dayHeaders.forEach((day, index) => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header text-center text-xs font-semibold p-1';
                dayHeader.textContent = day;
                if (index === 0) dayHeader.classList.add('sunday-header-color');
                else if (index === 6) dayHeader.classList.add('saturday-header-color');
                calendarGrid.appendChild(dayHeader);
            });
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month flex items-center justify-center aspect-square';
                dayElement.textContent = prevMonthLastDay - i;
                calendarGrid.appendChild(dayElement);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dayDate = new Date(year, month, day);

                dayElement.className = 'calendar-day flex items-center justify-center aspect-square cursor-pointer transition-transform duration-200 hover:scale-105 rounded-full';
                dayElement.textContent = day;

                const dayOfWeek = dayDate.getDay();
                if (dayOfWeek === 0) {
                    dayElement.classList.add('sunday-day-color');
                } else if (dayOfWeek === 6) {
                    dayElement.classList.add('saturday-day-color');
                }

                if (dayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                if (dayDate.toDateString() === currentDate.toDateString()) {
                    dayElement.classList.add('selected');
                }
                dayElement.addEventListener('click', () => {
                    currentDate = new Date(year, month, day);
                    updatePageForDate(currentDate);
                    closeCalendar();
                });
                calendarGrid.appendChild(dayElement);
            }
            const totalCells = firstDayOfWeek + daysInMonth;
            const remainingCells = (totalCells > 35) ? (42 - totalCells) : (35 - totalCells);

            for (let day = 1; day <= remainingCells; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month flex items-center justify-center aspect-square';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            }
        }

        function showCalendar() {
            const calendarModal = document.getElementById('calendar-modal');
            calendarDate = new Date(currentDate);
            generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            if (calendarModal) calendarModal.style.display = 'flex';
        }

        function closeCalendar() {
            const calendarModal = document.getElementById('calendar-modal');
            if (calendarModal) calendarModal.style.display = 'none';
        }

        function applyFontSize() {
            const contentIframe = document.getElementById('content-iframe');
            if (!contentIframe) return;

            const size = `${16 * (currentFontSize / 100)}px`;

            try {
                // 1. 메인 iframe
                const doc = contentIframe.contentDocument || contentIframe.contentWindow.document;
                doc.documentElement.style.fontSize = size;

                // 2. 중첩된 iframe (성경 본문 모달)
                const nestedIframe = doc.getElementById('modal-iframe');
                if (nestedIframe) {
                    try {
                        const nestedDoc = nestedIframe.contentDocument || nestedIframe.contentWindow.document;
                        nestedDoc.documentElement.style.fontSize = size;
                        nestedDoc.body.style.fontSize = size;
                    } catch (e) {
                        console.warn('Cannot access nested iframe:', e);
                    }
                }
            } catch (e) {
                console.warn('Cannot change font size due to security restrictions.');
            }
        }

        function changeFontSize(amount) {
            currentFontSize += amount;
            if (currentFontSize < 50) currentFontSize = 50;
            if (currentFontSize > 200) currentFontSize = 200;
            applyFontSize();
        }

        // Global Player Functions
        function initGlobalPlayer(iframeWindow) {
            const playerUI = document.getElementById('global-player');
            const playPauseBtn = document.getElementById('player-play-pause');
            const iconPlay = document.getElementById('icon-play');
            const iconPause = document.getElementById('icon-pause');
            const progressBar = document.getElementById('player-progress');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const speedSelect = document.getElementById('player-speed');
            const expandBtn = document.getElementById('player-expand');
            const closeBtn = document.getElementById('player-close');
            const playerTitle = document.getElementById('player-title');

            // Reset UI
            playerUI.style.display = 'block';
            setTimeout(() => playerUI.classList.remove('translate-y-full'), 10);

            // Poll for YT player
            let attempts = 0;
            const checkPlayer = setInterval(() => {
                attempts++;
                if (iframeWindow.player && typeof iframeWindow.player.getPlayerState === 'function') {
                    clearInterval(checkPlayer);
                    ytPlayer = iframeWindow.player;
                    console.log("YT Player found!");

                    // Default to Pause (User Request)
                    // ytPlayer.playVideo(); // Removed auto-play

                    // Start sync loop
                    startPlayerSync();
                } else if (attempts > 50) { // 5 seconds
                    clearInterval(checkPlayer);
                    console.warn("YT Player not found in iframe");
                    // If no player found, ensure content view is visible
                    document.getElementById('content-view').style.display = 'flex';
                }
            }, 100);

            // Controls
            playPauseBtn.onclick = () => {
                if (!ytPlayer) return;
                const state = ytPlayer.getPlayerState();
                if (state === 1) { // Playing
                    ytPlayer.pauseVideo();
                } else {
                    ytPlayer.playVideo();
                }
            };

            progressBar.oninput = () => {
                isDragging = true;
                const time = (progressBar.value / 100) * ytPlayer.getDuration();
                currentTimeEl.textContent = formatTime(time);
            };

            progressBar.onchange = () => {
                if (!ytPlayer) return;
                const time = (progressBar.value / 100) * ytPlayer.getDuration();
                ytPlayer.seekTo(time, true);
                isDragging = false;
            };

            speedSelect.onchange = () => {
                if (!ytPlayer) return;
                ytPlayer.setPlaybackRate(parseFloat(speedSelect.value));
            };

            expandBtn.onclick = () => {
                const contentView = document.getElementById('content-view');
                if (contentView.style.display === 'none') {
                    contentView.style.display = 'flex';
                } else {
                    contentView.style.display = 'none';
                }
            };

            closeBtn.onclick = () => {
                // Stop audio and hide player, but keep content
                if (playerInterval) clearInterval(playerInterval);
                if (ytPlayer && typeof ytPlayer.stopVideo === 'function') {
                    ytPlayer.stopVideo();
                }
                ytPlayer = null;

                const playerUI = document.getElementById('global-player');
                if (playerUI) {
                    playerUI.classList.add('translate-y-full');
                    setTimeout(() => playerUI.style.display = 'none', 300);
                }
            };
        }

        function startPlayerSync() {
            if (playerInterval) clearInterval(playerInterval);
            playerInterval = setInterval(() => {
                // Robustly check for player existence
                if (!ytPlayer) {
                    const contentIframe = document.getElementById('content-iframe');
                    if (contentIframe && contentIframe.contentWindow && contentIframe.contentWindow.player) {
                        ytPlayer = contentIframe.contentWindow.player;
                        console.log("Global player synced with internal player.");
                    }
                }

                if (!ytPlayer || !ytPlayer.getPlayerState) return;

                try {
                    const state = ytPlayer.getPlayerState();
                    const currentTime = ytPlayer.getCurrentTime();
                    const duration = ytPlayer.getDuration();

                    const playIcon = document.getElementById('icon-play');
                    const pauseIcon = document.getElementById('icon-pause');
                    const progressBar = document.getElementById('player-progress');
                    const currentTimeEl = document.getElementById('current-time');
                    const durationEl = document.getElementById('duration');

                    if (state === 1) { // Playing
                        playIcon.classList.add('hidden');
                        pauseIcon.classList.remove('hidden');
                    } else {
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                    }

                    if (!isDragging) {
                        progressBar.value = (currentTime / duration) * 100 || 0;
                        currentTimeEl.textContent = formatTime(currentTime);
                    }
                    durationEl.textContent = formatTime(duration);

                } catch (e) {
                    // Ignore errors if player is not ready
                }
            }, 500);
        }

        function showContent(url, title, buttonElement = null) {
            const contentView = document.getElementById('content-view');
            const contentIframe = document.getElementById('content-iframe');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessageDiv = document.getElementById('error-message');
            const playerTitle = document.getElementById('player-title');
            const contentTitle = document.getElementById('content-title');

            if (!contentView || !contentIframe || !loadingSpinner || !errorMessageDiv) return;

            // Set button loading state
            if (buttonElement) {
                buttonElement.classList.add('button-loading');
            }

            // Reset
            if (playerInterval) clearInterval(playerInterval);
            ytPlayer = null;

            playerTitle.textContent = "로딩 중... " + title;
            if (contentTitle) {
                contentTitle.textContent = title;
                contentTitle.classList.remove('hidden');
            }

            // Show modal immediately (User Request)
            contentView.style.display = 'flex';

            // Show Spinner, Hide Iframe initially
            loadingSpinner.style.display = 'block';
            contentIframe.style.display = 'none';
            errorMessageDiv.style.display = 'none';

            // Ensure iframe has a background
            contentIframe.style.backgroundColor = 'white';

            // Set URL
            contentIframe.src = url;
            console.log(`Loading content: ${url}`);

            // Safety timeout
            const loadTimeout = setTimeout(() => {
                if (loadingSpinner.style.display !== 'none') {
                    console.warn('Content load timed out. Forcing display.');
                    loadingSpinner.style.display = 'none';
                    contentIframe.style.display = 'block';
                    if (buttonElement) buttonElement.classList.remove('button-loading');
                }
            }, 8000);

            contentIframe.onload = () => {
                clearTimeout(loadTimeout);
                console.log('Content loaded successfully.');

                loadingSpinner.style.display = 'none';
                contentIframe.style.display = 'block';
                if (buttonElement) buttonElement.classList.remove('button-loading');

                playerTitle.textContent = title;

                // Try to init global player
                initGlobalPlayer(contentIframe.contentWindow);

                try {
                    const doc = contentIframe.contentDocument || contentIframe.contentWindow.document;
                    applyFontSize();
                    const maxWidthContainers = doc.querySelectorAll('.max-w-3xl');
                    maxWidthContainers.forEach(el => {
                        el.style.maxWidth = '100%';
                        el.style.paddingLeft = '2rem';
                        el.style.paddingRight = '2rem';
                        el.style.paddingBottom = '10rem'; // Add padding for player
                    });
                    const links = doc.querySelectorAll('a');
                    links.forEach(link => link.target = '_blank');

                    // Hide audio control button in iframe (User Request)
                    const elementsToHide = [
                        'audio-control-btn', // Daily Bible
                        'play-btn',          // Sermon
                        'audio-player',      // McCheyne (floating bar)
                        'audio-player-container' // Catechism
                    ];

                    elementsToHide.forEach(id => {
                        const el = doc.getElementById(id);
                        if (el) {
                            el.style.display = 'none';
                            // Hide parent if sticky (Daily Bible) or specific wrappers
                            if (id === 'audio-control-btn' && el.parentElement && el.parentElement.classList.contains('sticky')) {
                                el.parentElement.style.display = 'none';
                            }
                            // Hide parent container for Sermon button if it looks like a wrapper
                            if (id === 'play-btn' && el.parentElement && el.parentElement.classList.contains('bg-white')) {
                                el.parentElement.style.display = 'none';
                            }
                        }
                    });

                    // For McCheyne: Internal script now exposes window.player and has autoplay:0.
                    // We just need to ensure the global player picks it up.
                    if (url.includes('mc')) {
                        // No need for auto-click hacks anymore.
                        // The user can just click play on the global player.
                        // Or if we want to auto-load the first track but NOT play:
                        // The internal script loads the video when a button is clicked.
                        // If we want it to be ready, we might still need to trigger the load.
                        // But the user said "McCheyne plays immediately", which was the bug.
                        // Now it won't.
                        // If the user wants to play, they can click the global play button?
                        // Wait, if no video is loaded, global play button won't work.
                        // We need to load the video for the current tab *without* playing.
                        // McCheyne script doesn't have a "load but don't play" function exposed easily.
                        // But we can click the button (which calls loadVideoById) and then immediately pause?
                        // Or rely on the user clicking the tab/button?
                        // The user said "Global control not working".
                        // If we don't load a video, global control has nothing to control.
                        // So we SHOULD auto-load the video.

                        const attemptLoad = () => {
                            const doc = contentIframe.contentDocument || contentIframe.contentWindow.document;
                            const activeContent = doc.querySelector('.tab-content.active');
                            if (activeContent) {
                                const listenBtn = activeContent.querySelector('.listen-audio-btn');
                                if (listenBtn) {
                                    console.log("Auto-loading McCheyne video (paused)...");
                                    listenBtn.click();
                                    // The internal script now has autoplay:0, so clicking it should load it but NOT play it?
                                    // Wait, McCheyne script uses `loadVideoById`.
                                    // `loadVideoById` usually auto-plays.
                                    // We need `cueVideoById` to load without playing.
                                    // I should have checked McCheyne script for `loadVideoById`.
                                    // Let's assume I need to pause it if it starts.
                                }
                            }
                        };
                        setTimeout(attemptLoad, 1000);
                    }

                    // Catechism specific: Hide the entire audio section but keep it active
                    if (url.includes('dc')) {
                        const playerContainer = doc.getElementById('audio-player-container');
                        if (playerContainer) {
                            const section = playerContainer.closest('section');
                            if (section) {
                                section.style.visibility = 'hidden';
                                section.style.height = '0';
                                section.style.overflow = 'hidden';
                                section.style.margin = '0';
                                section.style.padding = '0';
                                section.style.border = 'none';
                            }
                        }
                    }

                    // Hide McCheyne listen buttons (Visual only)
                    const listenBtns = doc.querySelectorAll('.listen-audio-btn');
                    listenBtns.forEach(btn => btn.style.display = 'none');

                    // Restore McCheyne floating nav if it was hidden by our broad stroke?
                    // No, 'audio-player' id was hidden. Floating nav is 'floating-nav'.

                } catch (e) {
                    console.log('Cannot access iframe content:', e);
                }
            };

            // Intercept YT Player creation to expose it globally
            // This runs in parallel with onload to catch YT API loading
            const interceptInterval = setInterval(() => {
                try {
                    const iframeWindow = contentIframe.contentWindow;
                    if (iframeWindow && iframeWindow.YT && iframeWindow.YT.Player && !iframeWindow.YT.Player._intercepted) {
                        const OriginalPlayer = iframeWindow.YT.Player;
                        iframeWindow.YT.Player = function (id, options) {
                            const player = new OriginalPlayer(id, options);
                            iframeWindow.player = player; // Expose to window for global control
                            console.log("Intercepted YT Player creation!");

                            // Intercept loadVideoById to update global player title if possible
                            const originalLoadVideoById = player.loadVideoById;
                            player.loadVideoById = function (args) {
                                console.log("Video changed internally:", args);
                                // Call original
                                const result = originalLoadVideoById.apply(player, arguments);

                                // Update Global Player Title if we can find the title
                                // In McCheyne, the title is often in the button that triggered this, 
                                // but here we don't have easy access. 
                                // We can try to update the title to "재생 중..." or try to find the active tab title.
                                try {
                                    const doc = iframeWindow.document;
                                    const activeTab = doc.querySelector('.tab-btn.active');
                                    if (activeTab) {
                                        const title = activeTab.textContent;
                                        const parentTitle = document.getElementById('player-title');
                                        if (parentTitle) parentTitle.textContent = title;
                                    }
                                } catch (e) { }

                                // Ensure global player is playing (or paused based on default)
                                // The internal script might auto-play.
                                return result;
                            };

                            return player;
                        };
                        iframeWindow.YT.Player.prototype = OriginalPlayer.prototype;
                        iframeWindow.YT.Player._intercepted = true;
                        clearInterval(interceptInterval);
                    }
                } catch (e) {
                    // Ignore cross-origin errors if any (shouldn't happen for same origin)
                }
            }, 50);

            // Clear intercept interval after 10 seconds
            setTimeout(() => clearInterval(interceptInterval), 10000);

            contentIframe.onerror = () => {
                clearTimeout(loadTimeout);
                console.error('Failed to load content.');
                loadingSpinner.style.display = 'none';
                errorMessageDiv.innerHTML = `<h3 class='text-lg font-bold text-red-600 mb-2'>콘텐츠 로딩 실패</h3><p class='text-gray-700'>해당 날짜의 자료를 찾을 수 없습니다.<br>다른 날짜를 선택해주세요.</p>`;
                errorMessageDiv.style.display = 'block';
            };
        }

        function hideContent() {
            const contentView = document.getElementById('content-view');
            const contentIframe = document.getElementById('content-iframe');
            const playerUI = document.getElementById('global-player');

            if (playerInterval) clearInterval(playerInterval);
            if (ytPlayer && typeof ytPlayer.stopVideo === 'function') {
                ytPlayer.stopVideo();
            }
            ytPlayer = null;

            if (contentView) contentView.style.display = 'none';
            if (playerUI) {
                playerUI.classList.add('translate-y-full');
                setTimeout(() => playerUI.style.display = 'none', 300);
            }
            if (contentIframe) contentIframe.src = 'about:blank';
        }

        document.addEventListener('DOMContentLoaded', () => {
            updatePageForDate(currentDate);

            document.getElementById('prev-day').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 1);
                updatePageForDate(currentDate);
            });
            document.getElementById('next-day').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 1);
                updatePageForDate(currentDate);
            });

            document.getElementById('date-picker').addEventListener('click', showCalendar);

            const calendarModal = document.getElementById('calendar-modal');
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');
            const closeCalendarButton = document.getElementById('close-calendar');

            if (prevMonthButton) prevMonthButton.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            });
            if (nextMonthButton) nextMonthButton.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
            });
            if (closeCalendarButton) closeCalendarButton.addEventListener('click', closeCalendar);
            if (calendarModal) calendarModal.addEventListener('click', (e) => {
                if (e.target === calendarModal) closeCalendar();
            });
            // 주일설교 버튼 이벤트 리스너
            const sermonButtons = document.querySelectorAll('.sermon-button');
            sermonButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const url = e.currentTarget.dataset.url;
                    const title = `주일강설: ${e.currentTarget.textContent}`;
                    if (url) {
                        showContent(url, title, e.currentTarget);
                    }
                });
            });

            // 매일의 말씀, 맥체인, 교리 버튼 이벤트 리스너
            document.querySelectorAll('.link-container button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const container = e.currentTarget.closest('.link-container');
                    const url = e.currentTarget.dataset.url;
                    const title = container.querySelector('span').textContent;
                    if (url) {
                        showContent(url, title, e.currentTarget);
                    }
                });
            });

            document.getElementById('home-button').addEventListener('click', () => {
                hideContent();
            });

            document.getElementById('font-decrease').addEventListener('click', () => changeFontSize(-10));
            document.getElementById('font-increase').addEventListener('click', () => changeFontSize(10));

            window.addEventListener('resize', () => updatePageForDate(currentDate));

            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        }, err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }
        });
    </script>
</body>

</html>